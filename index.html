<!doctype html>

<html>

  </head>
    <title>Hello Plugins!</title>
  </head>

  <body>
    <h1>Hello Plugins!</h1>
    <details>
      <summary>Instructions</summary>
      <ul>
        <li>First, click "Connect". Then, try out the other buttons!</li>
        <li>Please note that:</li>
        <ul>
          <li>
            The Snap <b>package.json</b> must be located in located in the server root directory
          </li>
          <li>
            The Snap bundle must be hosted at the location specified by <b>package.json:web3Wallet:bundle:url</b>
          </li>
        </ul>
      </ul>
    </details>
    <br/>

    <div class="pk-container" style="margin-bottom: 10px">
      <label class="">Public key:</label>
      <div class="pk"></div>
    </div>
    <button class="connect">Connect</button>
    <div class="prk-container" style="margin-bottom: 10px">
      <label class="">Private key:</label>
      <div class="prk"></div>
    </div>
    <button class="export-pk">Export private key</button>

  </body>

  <script>

    const origin = new URL('package.json', window.location.href).toString();
    const snapId = `wallet_plugin_${origin}`;

    const connectButton = document.querySelector('button.connect');
    const exportButton = document.querySelector('button.export-pk');
    const pkLabel = document.querySelector('div.pk');
    const privateKeyLabel = document.querySelector('div.prk');

    connectButton.addEventListener('click', connect);
    exportButton.addEventListener('click', exportPk);
    connectButton.disabled = true; // until keypair is fetched

    fetchPublicKey().then((fetched) => {
      if (fetched) {
        // todo
      } else {
        pkLabel.innerHTML = "Snap not connected";
        connectButton.disabled = false;
      }
    }).catch(reason => console.log(reason));

    async function exportPk() {
      let response = null;
      try {
        response = await ethereum.send({
          method: snapId,
          params: [{
            method: 'exportPrivateKey'
          }]
        });
      } catch (e) {
        console.log("Keys not generated");
      }
      if (response != null) {
        privateKeyLabel.innerHTML = response;
        return true;
      }
      return false;
    }

    async function fetchPublicKey() {
      let response = null;
      try {
        response = await ethereum.send({
          method: snapId,
          params: [{
            method: 'getPublicKey'
          }]
        });
      } catch (e) {
        console.log("Keys not generated");
      }
      if (response != null) {
        pkLabel.innerHTML = response;
        return true;
      }
      return false;
    }

    async function connect () {
      await ethereum.send({
        method: 'wallet_requestPermissions',
        params: [{
          [snapId]: {}
        }]
      });
      await fetchPublicKey();
    }

  </script>

</html>
